name: CI/CD Site Estático

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sast:
    name: Verificação com Lint HTML, CSS e JS
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Linters
        run: |
          npm install -g htmlhint eslint@8 stylelint stylelint-config-recommended

      - name: Lint HTML
        run: htmlhint **/*.html

      - name: Lint CSS
        run: stylelint "css/**/*.css"

      - name: Lint JS
        run: eslint js/**/*.js

  deploy:
    name: Deploy para GitHub Pages
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: sast
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    outputs:
      deployment_page_url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./

      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4

  dast:
    name: Análise Dinâmica com OWASP ZAP
    runs-on: ubuntu-latest
    if: needs.deploy.outputs.deployment_page_url != ''
    needs: deploy
    permissions:
      issues: write
      security-events: write
      actions: write
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Esperando o site ficar disponível
        run: |
          url="${{ needs.deploy.outputs.deployment_page_url }}"
          echo "Aguardando $url..."
          for i in {1..24}; do
            [ "$(curl -s -o /dev/null -w '%{http_code}' "$url")" = "200" ] && exit 0
            sleep 5
          done
          echo "Timeout: site indisponível"; exit 1

      - name: Rodando ZAP Baseline e gerando SARIF
        continue-on-error: true
        run: |
          docker run --rm -u root \
            -v "$(pwd):/zap/wrk/:rw" \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t "${{ needs.deploy.outputs.deployment_page_url }}" \
            -J zap-report.sarif

      - name: Upload do relatório SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: zap-report.sarif